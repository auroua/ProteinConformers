# Protein Decoy Ensemble Evaluation Pipeline

A comprehensive evaluation framework for assessing the quality and similarity of protein decoy ensembles against ground truth conformational ensembles.

## Overview

This pipeline evaluates protein decoy ensembles generated by different models against a ground truth (GT) conformational ensemble, typically derived from Molecular Dynamics (MD) simulations. The evaluation framework implements multiple metrics inspired by the ESMDiff paper and established practices in structural bioinformatics.

### Core Components

- **`eval_utils.py`**: Core utility functions for loading PDBs, calculating features, and computing evaluation metrics
- **`eval_decoy_metrics.py`**: Main executable script with command-line interface for ensemble comparison

## Evaluation Metrics

### 1. Jensen-Shannon Divergence (JS-Div) Metrics
- **`JS-PwD`**: Based on C-alpha pairwise distance distributions
- **`JS-Rg`**: Based on Radius of Gyration distributions
- **`JS-TIC`**: Based on Time-lagged Independent Components (derived from pairwise distances)

### 2. Ensemble Coverage Metrics
- **`RMSD-ens`**: Average minimum C-alpha RMSD of GT structures to the generated ensemble
- **`TM-ens`**: Average maximum TM-score of GT structures to the generated ensemble (requires TMalign)

### 3. Structural Validity Metrics
- **`Validity_Model`**: Fraction of clash-free structures in the generated ensemble

## Environment Setup

### 1. Create Conda Environment

```bash
conda create -n conformer_eval python=3.9  # Or your preferred Python version
conda activate conformer_eval
```

### 2. Install Dependencies

```bash
pip install numpy pandas scipy tqdm biopython deeptime
```

**Package descriptions:**
- `numpy`, `pandas`, `scipy`, `tqdm`: Standard data handling and utility libraries
- `biopython`: For PDB file parsing and structural calculations (e.g., RMSD)
- `deeptime`: For TICA calculations (used in JS-TIC metric)

### 3. Install TMalign (Required for TM-ens metric)

1. Download TMalign from [Zhang Lab TM-align Page](https://zhanggroup.org/TM-align/)
   - C++ version recommended for speed and features
2. Compile if necessary, or use a precompiled binary for your system
3. Note the full path to the TMalign executable for use in evaluation scripts

## Directory Structure and Data Preparation

### 1. Model-Generated Decoys Root Directory (`--model_decoys_root_dir`)

Base directory containing subdirectories for each model's output.

**Structure:**
```
model_decoys_root/
├── esmdiff_decoys/
│   ├── T1033/
│   │   ├── decoys_001.pdb
│   │   ├── decoys_002.pdb
│   │   └── ...
│   └── T1033_decoys.csv  # TM-scores for filtering
├── bioemu_decoys/
│   └── ...
```

**CSV Format** (for TM-score filtering):
- `decoy`: Full path to PDB or just filename
- `tmscore`: TM-score value against native structure

### 2. Native PDBs Root Directory (`--native_pdb_root_dir`)

Directory containing single reference native PDB structure for each protein target.

**Structure:**
```
native_pdbs_root/
├── T1033.pdb
├── T1034.pdb
└── ...
```

### 3. Ground Truth (MD) Decoys Root Directory (`--gt_decoys_root_dir`)

Base directory for MD simulation benchmark dataset.

**Structure:**
```
gt_decoys_root/
├── T1033/
│   └── decoys_MD/
│       ├── frame_001.pdb
│       ├── frame_002.pdb
│       └── ...  # Can be in subdirectories (searched recursively)
└── ...
```

### 4. TMalign Executable Path (`--tmalign_path`)

Full path to your compiled TMalign executable.

### 5. Output Directory (`--output_dir`)

Directory where the evaluation results CSV file will be saved.

## Running the Evaluation

### Command-Line Arguments

| Argument | Type | Description | Default |
|----------|------|-------------|---------|
| `--protein_id` | Required | Protein target ID (e.g., T1033) | - |
| `--model_name` | Required | Model name (e.g., esmdiff, bioemu) | - |
| `--native_filter` | Optional | Filter decoys by TM-score to native (`all`, `near`, `non`) | `all` |
| `--tmscore_threshold` | Optional | TM-score threshold for filtering | `0.5` |
| `--model_decoys_root_dir` | Required | Path to model decoys root directory | - |
| `--native_pdb_root_dir` | Required | Path to native PDB structures | - |
| `--gt_decoys_root_dir` | Required | Path to MD benchmark dataset | - |
| `--tmalign_path` | Required | Full path to TMalign executable | - |
| `--output_dir` | Required | Directory for evaluation results | - |
| `--skip_tica` | Optional | Skip JS-TIC calculation (time-consuming) | False |
| `--skip_tmens` | Optional | Skip TM-ens calculation (requires TMalign) | False |

### Native Filtering Options

- **`all`**: Use all successfully loaded model decoys
- **`near`**: Use decoys with TM-score (vs native) ≥ threshold
- **`non`**: Use decoys with TM-score (vs native) < threshold

### Example Commands

#### Basic Evaluation

```bash
python src/eval/eval_decoy_metrics.py \
    --protein_id T1033 \
    --model_name esmdiff \
    --native_filter all \
    --model_decoys_root_dir /path/to/model/decoys \
    --native_pdb_root_dir /path/to/native/pdbs \
    --gt_decoys_root_dir /path/to/ground/truth \
    --tmalign_path /path/to/TMalign_cpp \
    --output_dir /path/to/output
```

#### Evaluation with Native-Near Filtering

```bash
python src/eval/eval_decoy_metrics.py \
    --protein_id T1033 \
    --model_name bioemu \
    --native_filter near \
    --tmscore_threshold 0.6 \
    --model_decoys_root_dir /path/to/model/decoys \
    --native_pdb_root_dir /path/to/native/pdbs \
    --gt_decoys_root_dir /path/to/ground/truth \
    --tmalign_path /path/to/TMalign_cpp \
    --output_dir /path/to/output
```

#### Fast Evaluation (Skip Time-Consuming Metrics)

```bash
python src/eval/eval_decoy_metrics.py \
    --protein_id T1033 \
    --model_name esmdiff \
    --native_filter all \
    --model_decoys_root_dir /path/to/model/decoys \
    --native_pdb_root_dir /path/to/native/pdbs \
    --gt_decoys_root_dir /path/to/ground/truth \
    --tmalign_path /path/to/TMalign_cpp \
    --output_dir /path/to/output \
    --skip_tica \
    --skip_tmens
```

## Testing the Evaluation Pipeline

### Test with Partial Data

For testing purposes, you can use a smaller dataset to verify the pipeline is working correctly.

**Note**: Small ground truth sizes may not be sufficient for computing JS-TIC (requires lag = 20), so the metric may be automatically skipped.

#### Example Test Command

```bash
# Navigate to test directory (if available)
cd /path/to/test/data

# Run evaluation on test data
python src/eval/eval_decoy_metrics.py \
    --protein_id T1033 \
    --model_name bioemu \
    --native_filter all \
    --tmscore_threshold 0.5 \
    --model_decoys_root_dir ./test_data/model_decoys \
    --native_pdb_root_dir ./test_data/native_pdbs \
    --gt_decoys_root_dir ./test_data/md_decoys \
    --tmalign_path /path/to/TMalign_cpp \
    --output_dir ./test_output
```

## Output Format

The evaluation script generates a CSV file in the specified output directory with the following naming convention:
`{protein_id}_{model_name}_{native_filter}_metrics.csv`

### Output Columns

| Column | Description |
|--------|-------------|
| `protein_id` | Protein target identifier |
| `model_name` | Model name used for generation |
| `native_filter` | Filter type applied (all/near/non) |
| `tmscore_threshold` | TM-score threshold used for filtering |
| `model_ensemble_size` | Number of model structures evaluated |
| `gt_ensemble_size` | Number of ground truth structures |
| `JS_PwD` | Jensen-Shannon divergence for pairwise distances |
| `JS_PwD_time` | Computation time for JS_PwD (seconds) |
| `JS_Rg` | Jensen-Shannon divergence for radius of gyration |
| `JS_Rg_time` | Computation time for JS_Rg (seconds) |
| `JS_TIC` | Jensen-Shannon divergence for TICA components |
| `JS_TIC_time` | Computation time for JS_TIC (seconds) |
| `Validity_Model` | Fraction of valid (clash-free) structures |
| `Validity_Model_time` | Computation time for validity check (seconds) |
| `RMSD_ens` | Average minimum RMSD to ground truth |
| `RMSD_ens_time` | Computation time for RMSD_ens (seconds) |
| `TM_ens` | Average maximum TM-score to ground truth |
| `TM_ens_time` | Computation time for TM_ens (seconds) |

## Troubleshooting

### Common Issues

1. **JS-TIC calculation skipped**: Ensure you have sufficient ground truth samples (> lag time, default 20)
2. **TMalign not found**: Verify the path to TMalign executable is correct and the file is executable
3. **Memory issues with large ensembles**: Consider processing in batches or increasing available memory
4. **PDB parsing errors**: Ensure all PDB files have consistent C-alpha atom counts

### Performance Tips

- Use `--skip_tica` for faster evaluation when JS-TIC is not critical
- Use `--skip_tmens` to avoid time-consuming TM-score calculations
- Consider parallel processing for large-scale evaluations by running multiple protein targets simultaneously

## References

For more information about the metrics and methodology, please refer to:
- ESMDiff paper for JS-divergence metrics
- Zhang Lab publications for TM-score methodology
- ProteinConformers main documentation for overall framework context